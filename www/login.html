<?
ini_set('session.use_only_cookies', 1);
session_start();
foreach ($_SESSION as $k => $v)
{
    echo "<p>".$k." : ".$v."</p>";
}
if (array_key_exists('token', $_GET))
{
    include_once("rpx.php");
    include_once("gravatar.php");
    try
    {
        $rpx = new RPX("2013e9e4d57d026d062ffe67f764badd76ef925a",
                       "https://fanglr.rpxnow.com/");
        $profile = $rpx->get_profile($rpx->auth_info($_GET['token']));
    }
    catch (APIException $e)
    {
        $_SESSION['error'] = "Your login attempt failed for some reason.";
        $rpx = NULL;
    }
}
if (isset($profile))
{
    $gravatar = new Gravatar($profile['email'], $profile['avatar']);
    $gravatar->size = 120;
    $gravatar->rating = "G";
    if ($profile['email'] != "")
    {
        $gravatar->setDefault("http://friedcellcollective.net/monsterid/".
                              $gravatar->gravatar_id."/120");
    }
    $_SESSION['id'] = 0;
    $_SESSION['name'] = $profile['name'];
    $_SESSION['avatar'] = $gravatar->toHTML();
}
header("Location: ".$_SESSION["back"]);
?>
