<?
require_once("l10n.php");
if (array_key_exists('token', $_GET))
{
    include_once("rpx.php");
    include_once("gravatar.php");
    $rpx = new RPX("2013e9e4d57d026d062ffe67f764badd76ef925a",
                   "https://fanglr.rpxnow.com/");
    $profile = $rpx->get_profile($rpx->auth_info($_GET['token']));
    $gravatar = new Gravatar($profile['email'], $profile['avatar']);
    $gravatar->size = 128;
    $gravatar->rating = "G";
    if ($profile['email'] != "")
    {
        $gravatar->setDefault("http://friedcellcollective.net/monsterid/".
                              $gravatar->gravatar_id."/128");
    }
    ini_set("session.cookie_domain",substr($_SERVER[HTTP_HOST],3));
    session_start();
    # Find or add to database;
    $_SESSION['id'] = 0;
    $_SESSION['name'] = $profile['name'];
    $_SESSION['avatar'] = $gravatar->toHTML();
    # Redirect to user page
    # Maintain authenticated session
    # Allow user to modify nickname (use profile by default, if not a dupe)
    header('Location: http://localhost/fanglr/user.html');
}
else
{
print '<?xml version="1.0" encoding="utf-8"?>'."\n";
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head> 
<title>fanglr - organize and share your game library</title>
<meta http-equiv="content-type" content="text/html;charset=utf-8" />
<meta http-equiv="Content-Style-Type" content="text/css" />
</head>
<body>
<h1><?echo _("log into fanglr with open id");?></h1>
<iframe src="https://fanglr.rpxnow.com/openid/embed?token_url=<?echo urlencode("http://localhost/fanglr/login.html")?>" scrolling="no" frameBorder="no" style="width:400px;height:240px;">
</iframe>
<p><a href="privacy.html"><?echo _("privacy policy");?></a></p>
<?
}
?>
</body>
</html>
